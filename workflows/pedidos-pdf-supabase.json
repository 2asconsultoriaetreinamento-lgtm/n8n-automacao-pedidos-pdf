{
  "name": "Automacao Pedidos PDF - Taschibra v4.1",
  "nodes": [
    {
      "parameters": {"rule": "everyMinute"},
      "id": "SchedulerTrigger",
      "name": "Scheduler (Cron)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [100, 100],
      "disabled": false
    },
    {
      "parameters": {"filePath": "/data/pedidos/{{ now('YYYY-MM-DD') }}.pdf"},
      "id": "ReadPDFFile",
      "name": "Read Binary File (PDF)",
      "type": "n8n-nodes-base.readBinaryFile",
      "typeVersion": 1,
      "position": [300, 100]
    },
    {
      "parameters": {"functionCode": "const textContent = $json.data; const regexPatterns = {numero_pedido: /(?:Pedido|PED|PEDIDO)[\\s#:]*([\\d]{6,})/i, data_emissao: /(\\d{2})[\\/\\-](\\d{2})[\\/\\-](\\d{4})/, cliente_nome: /(?:Cliente|CLIENTE)[\\s:]*([^\\n,]+)/i, cliente_cnpj: /(?:CNPJ|CPF)[\\s:]*([\\d\\.\\-\\/]+)/i, cidade: /(?:Cidade|CIDADE)[\\s:]*([^,\\n]+)/i, uf: /(?:UF|Estado)[\\s:]*([A-Z]{2})/i, valor_total: /(?:Total|TOTAL|Valor Total)[\\s:]*R\\$\\s*([\\d,.]+)/i}; const pedido = {}; for (const [key, regex] of Object.entries(regexPatterns)) {const match = textContent.match(regex); if (match) {pedido[key] = match[match.length - 1]?.trim() || null;} else {pedido[key] = null;}} const itens = []; const itemRegex = /^\\s*\\d+\\.?\\s+(.+?)\\s+(\\d+,?\\d*)\\s+x?\\s+R\\$\\s*([\\d,.]+)/gm; let itemMatch; while ((itemMatch = itemRegex.exec(textContent)) !== null) {itens.push({descricao_produto: itemMatch[1]?.trim() || 'N/A', quantidade: parseInt(itemMatch[2]?.replace(',', '')) || 0, valor_unitario: parseFloat(itemMatch[3]?.replace(/[^\\d,]/g, '').replace(',', '.')) || 0, status: 'novo'});} return {pedido, itens, total_itens: itens.length, processado_em: new Date().toISOString()};"},
      "id": "ParseData",
      "name": "Parse Data (Code)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 100]
    },
    {
      "parameters": {"url": "{{ $env.SUPABASE_URL }}/rest/v1/pedidos?numero_pedido=eq.{{ $node.ParseData.json.pedido.numero_pedido }}", "method": "GET", "authentication": "headerAuth", "headerAuth.Headers": {"Authorization": "Bearer {{ $env.SUPABASE_KEY }}", "Content-Type": "application/json"}},
      "id": "CheckDuplicate",
      "name": "HTTP GET - Verificar Duplicidade",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [700, 100],
      "continueOnFail": true
    },
    {
      "parameters": {"conditions": {"conditions": [{"value1": "{{ $json.length }}", "operator": "equal", "value2": 0}], "combinator": "and"}},
      "id": "ValidateDuplicateCondition",
      "name": "IF - Nao Duplicado?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [900, 100]
    },
    {
      "parameters": {"url": "{{ $env.SUPABASE_URL }}/rest/v1/pedidos", "method": "POST", "authentication": "headerAuth", "headerAuth.Headers": {"Authorization": "Bearer {{ $env.SUPABASE_SECRET_KEY }}", "Content-Type": "application/json", "Prefer": "return=representation"}, "bodyParametersUi": "json", "body": {"numero_pedido": "{{ $node.ParseData.json.pedido.numero_pedido }}", "data_pedido": "{{ $node.ParseData.json.pedido.data_emissao }}", "cliente_nome": "{{ $node.ParseData.json.pedido.cliente_nome }}", "cliente_cnpj": "{{ $node.ParseData.json.pedido.cliente_cnpj }}", "cidade": "{{ $node.ParseData.json.pedido.cidade }}", "uf": "{{ $node.ParseData.json.pedido.uf }}", "valor_total": "{{ $node.ParseData.json.pedido.valor_total }}", "status": "novo"}},
      "id": "InsertPedido",
      "name": "HTTP POST - Inserir Pedido",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1100, 100],
      "continueOnFail": true
    },
    {
      "parameters": {"url": "={{ $env.SUPABASE_URL + '/rest/v1/itens_pedido' }}", "method": "POST", "authentication": "headerAuth", "headerAuth.Headers": {"Authorization": "Bearer {{ $env.SUPABASE_SECRET_KEY }}", "Content-Type": "application/json", "Prefer": "return=representation"}, "bodyParametersUi": "json", "body": {"pedido_id": "={{ $node.InsertPedido.json.response[0].id }}", "descricao_produto": "={{ $node.ParseData.json.itens.map((item, index) => ({descricao: item.descricao_produto, qtd: item.quantidade, valor: item.valor_unitario}))[0]?.descricao }}", "quantidade": "={{ $node.ParseData.json.itens[0]?.quantidade }}", "valor_unitario": "={{ $node.ParseData.json.itens[0]?.valor_unitario }}", "status": "novo"}},
      "id": "InsertItens",
      "name": "HTTP POST - Inserir Itens (Simplificado)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1300, 100],
      "continueOnFail": true
    },
    {
      "parameters": {"url": "{{ $env.SUPABASE_URL }}/rest/v1/logs_processamento", "method": "POST", "authentication": "headerAuth", "headerAuth.Headers": {"Authorization": "Bearer {{ $env.SUPABASE_SECRET_KEY }}", "Content-Type": "application/json"}, "bodyParametersUi": "json", "body": {"tipo_evento": "insercao_sucesso", "mensagem": "Pedido {{ $node.ParseData.json.pedido.numero_pedido }} inserido com sucesso", "status_sucesso": true}},
      "id": "LogSucesso",
      "name": "HTTP POST - Log Sucesso",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1500, 100],
      "continueOnFail": true
    },
    {
      "parameters": {"url": "{{ $env.SUPABASE_URL }}/rest/v1/logs_processamento", "method": "POST", "authentication": "headerAuth", "headerAuth.Headers": {"Authorization": "Bearer {{ $env.SUPABASE_SECRET_KEY }}", "Content-Type": "application/json"}, "bodyParametersUi": "json", "body": {"tipo_evento": "duplicidade_detectada", "mensagem": "Pedido {{ $node.ParseData.json.pedido.numero_pedido }} ja existe", "status_sucesso": false}},
      "id": "LogDuplicidade",
      "name": "HTTP POST - Log Duplicidade",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [900, 250],
      "continueOnFail": true
    }
  ],
  "connections": {
    "SchedulerTrigger": {"main": [[{"node": "ReadPDFFile", "type": "main", "index": 0}]]},
    "ReadPDFFile": {"main": [[{"node": "ParseData", "type": "main", "index": 0}]]},
    "ParseData": {"main": [[{"node": "CheckDuplicate", "type": "main", "index": 0}]]},
    "CheckDuplicate": {"main": [[{"node": "ValidateDuplicateCondition", "type": "main", "index": 0}]]},
    "ValidateDuplicateCondition": {"main": [[{"node": "InsertPedido", "type": "main", "index": 0}], [{"node": "LogDuplicidade", "type": "main", "index": 0}]]},
    "InsertPedido": {"main": [[{"node": "InsertItens", "type": "main", "index": 0}]]},
    "InsertItens": {"main": [[{"node": "LogSucesso", "type": "main", "index": 0}]]}
  },
  "active": false,
  "settings": {"saveManualExecutions": true, "errorHandler": "save", "timeout": 3600},
  "version": 4.1,
  "description": "Fluxo v4.1 - Corrigido para compatibilidade n8n - Removido Loop node problematico. Fluxo linear direto: Leitura PDF > Parsing > Validacao > Insercao Pedido > Insercao Itens > Logging. Versao simplificada focada em primeiro item (v4.1). Pronto para n8n."
}
